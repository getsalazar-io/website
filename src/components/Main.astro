---
import Presentation from "./SectionPresentation.astro";
import Capabilities from "./SectionCapabilities.astro";
import Features from "./SectionFeatures.astro";
import Form from "./SectionForm.astro";
import Hero from "./SectionHero.astro";
import Faq from "./SectionFAQ.astro";
import Carousel from "./SectionCarousel.astro";
import Strategies from "./SectionStrategies.astro";
---

<main>
  <section class="main-section-hero snap-section">
    <Hero />
  </section>
  <section class="main-section-strategies snap-section">
    <Strategies />
  </section>
  <section class="main-section-features snap-section">
    <Features />
  </section>
  <section class="main-section-presentation snap-section">
    <Presentation />
  </section>
  <section class="main-section-carousel snap-section">
    <Carousel />
  </section>
  <section class="main-section-capabilities snap-section">
    <Capabilities />
  </section>
  <section class="main-section-faq snap-section">
    <Faq />
  </section>
  <section class="main-section-form snap-section">
    <Form />
  </section>
  <div class="scroll-down" id="scrollDown">
    <span class="pi pi-arrow-down"></span>
  </div>
</main>

<script>
  const VIEWPORT_THRESHOLD = 0.2; // 20% del tamaño de la pantalla
  const SNAP_OFFSET = -200; // Píxeles por encima de la sección
  let isSnapping = false;

  function initTouchSnap() {
    // Solo activar en móvil
    if (window.innerWidth > 768) return;

    const sections = Array.from(document.querySelectorAll('.snap-section'));

    // Función para hacer scroll a una posición específica
    function scrollToSection(section) {
      const sectionTop = section.getBoundingClientRect().top + window.scrollY;
      const targetScroll = sectionTop + SNAP_OFFSET;

      window.scrollTo({ 
        top: targetScroll,
        behavior: 'smooth'
      });
    }

    // Al soltar el touch
    function handleTouchEnd() {
      if (isSnapping) return;

      const viewportHeight = window.innerHeight;
      const thresholdFromBottom = viewportHeight * (1 - VIEWPORT_THRESHOLD); // 80% desde arriba = 20% desde abajo
      const thresholdFromTop = viewportHeight * VIEWPORT_THRESHOLD; // 20% desde arriba

      // Buscar si alguna sección cumple las condiciones de snap
      for (let i = 0; i < sections.length; i++) {
        const currentSection = sections[i];
        const rect = currentSection.getBoundingClientRect();
        
        // SNAP HACIA ABAJO: la parte superior de la siguiente sección superó el 20% desde abajo
        if (i < sections.length - 1) {
          const nextSection = sections[i + 1];
          const nextRect = nextSection.getBoundingClientRect();
          const nextSectionTop = nextRect.top;

          // Si el top de la siguiente sección está entre el 80% y 100% del viewport (pasó el 20% desde abajo)
          if (nextSectionTop > 0 && nextSectionTop < thresholdFromBottom) {
            isSnapping = true;
            
            scrollToSection(nextSection);

            setTimeout(() => {
              isSnapping = false;
            }, 800);
            
            return; // Salir después de hacer snap
          }
        }

        // SNAP HACIA ARRIBA: la parte inferior de la sección anterior superó el 20% desde arriba
        if (i > 0) {
          const prevSection = sections[i - 1];
          const prevRect = prevSection.getBoundingClientRect();
          const prevSectionBottom = prevRect.bottom;

          // Si el bottom de la sección anterior está entre 0 y 20% del viewport (pasó el 20% desde arriba)
          if (prevSectionBottom > thresholdFromTop && prevSectionBottom < viewportHeight) {
            isSnapping = true;
            
            scrollToSection(prevSection);

            setTimeout(() => {
              isSnapping = false;
            }, 800);
            
            return; // Salir después de hacer snap
          }
        }
      }

      // Si no se cumple ninguna condición, el scroll queda libre
    }

    // Agregar listener
    document.addEventListener('touchend', handleTouchEnd, { passive: true });

    // Cleanup al cambiar a desktop
    const handleResize = () => {
      if (window.innerWidth > 768) {
        document.removeEventListener('touchend', handleTouchEnd);
        window.removeEventListener('resize', handleResize);
      }
    };

    window.addEventListener('resize', handleResize);
  }

  // Inicializar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTouchSnap);
  } else {
    initTouchSnap();
  }
</script>

<style>
  main {
    display: flex;
    flex-flow: column;
    gap: 110px;
    width: 100%;
    margin-top: -90px;
  }

  .main-section-hero {
    position: relative;
    z-index: 0;
    height: 135vh;
  }

  .main-section-hero::after {
    display: block;
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 568px;
    margin-top: 40px;
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center 1%;
    z-index: -1;
  }

  .main-section-features {
    background: linear-gradient(
      186.5deg,
      rgba(11, 11, 11, 0.2) 28.3%,
      rgba(76, 167, 223, 0.2) 48.66%,
      rgba(11, 11, 11, 0.2) 71.03%
    );
  }

  .main-section-presentation {
    background: linear-gradient(
      180deg,
      rgba(11, 11, 11, 0.2) 10.08%,
      rgba(76, 167, 223, 0.2) 43.35%,
      rgba(11, 11, 11, 0.2) 79.9%
    );
  }

  .main-section-form {
    background: url("/images/bgImg_Hero_DarkDeath2x.webp");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center top;
    transition: all 350ms ease-in-out;
  }

  .main-section-faq {
    background: linear-gradient(
      187.39deg,
      rgba(11, 11, 11, 0.2) 28.3%,
      rgba(76, 167, 223, 0.2) 48.66%,
      rgba(11, 11, 11, 0.2) 71.03%
    );
  }

  .main-section-carousel {
    background: linear-gradient(
      184.39deg,
      rgba(11, 11, 11, 0.2) 28.3%,
      rgba(76, 167, 223, 0.2) 48.66%,
      rgba(11, 11, 11, 0.2) 71.03%
    );
  }

  .main-section-capabilities {
    background: linear-gradient(
      184.39deg,
      rgba(11, 11, 11, 0.2) 28.3%,
      rgba(76, 167, 223, 0.2) 48.66%,
      rgba(11, 11, 11, 0.2) 71.03%
    );
  }

  .scroll-down {
    width: 37px;
    height: 86px;
    border: 1px solid white;
    border-radius: 37px;
    display: flex;
    justify-content: center;
    padding: 20px 0;
    align-items: top;
    position: fixed;
    left: 50%;
    transform: translate(-50%, 0);
    bottom: 25px;
    opacity: 1;
    transition: opacity 0.3s ease;
    z-index: 5;
  }

  .scroll-down.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .scroll-down span {
    animation: bounce 2s infinite;
  }

  @media screen and (min-width: 1440px) {
    .main-section-form {
      background-position: calc(50% - 200px) center;
    }
  }

  @media (max-width: 768px) {
    .main-section-hero {
      min-height: 150vh;
    }

    .scroll-down {
      display: none;
    }
  }
</style>