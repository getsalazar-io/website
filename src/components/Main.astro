---
import Presentation from "./SectionPresentation.astro";
import Capabilities from "./SectionCapabilities.astro";
import Features from "./SectionFeatures.astro";
import Form from "./SectionForm.astro";
import Hero from "./SectionHero.astro";
import Faq from "./SectionFAQ.astro";
import Carousel from "./SectionCarousel.astro";
import Strategies from "./SectionStrategies.astro";
---

<main>
  <section class="main-section-hero snap-section">
    <Hero />
  </section>
  <section class="main-section-strategies snap-section">
    <Strategies />
  </section>
  <section class="main-section-features snap-section">
    <Features />
  </section>
  <section class="main-section-presentation snap-section">
    <Presentation />
  </section>
  <section class="main-section-carousel snap-section">
    <Carousel />
  </section>
  <section class="main-section-capabilities snap-section">
    <Capabilities />
  </section>
  <section class="main-section-faq snap-section">
    <Faq />
  </section>
  <section class="main-section-form snap-section">
    <Form />
  </section>
  <div class="scroll-down" id="scrollDown">
    <span class="pi pi-arrow-down"></span>
  </div>
</main>

<script>
  const SCROLL_THRESHOLD = 0.2; // 20% del tamaño de la sección
  const SNAP_OFFSET = -150; // Píxeles por encima de la sección
  let touchStartY = 0;
  let scrollStartY = 0;
  let isSnapping = false;

  function initTouchSnap() {
    // Solo activar en móvil
    if (window.innerWidth > 768) return;

    const sections = Array.from(document.querySelectorAll('.snap-section'));

    // Función para encontrar la sección más visible
    function getCurrentSection() {
      let maxVisibility = 0;
      let currentSection = null;
      let currentIndex = -1;

      sections.forEach((section, index) => {
        const rect = section.getBoundingClientRect();
        const sectionHeight = rect.height;
        const visibleHeight = Math.min(rect.bottom, window.innerHeight) - Math.max(rect.top, 0);
        const visibility = visibleHeight / sectionHeight;

        if (visibility > maxVisibility) {
          maxVisibility = visibility;
          currentSection = section;
          currentIndex = index;
        }
      });

      return { section: currentSection, index: currentIndex };
    }

    // Función para hacer scroll a una posición específica
    function scrollToSection(section) {
      const sectionTop = section.getBoundingClientRect().top + window.scrollY;
      const targetScroll = sectionTop + SNAP_OFFSET;

      window.scrollTo({ 
        top: targetScroll,
        behavior: 'smooth'
      });
    }

    // Al iniciar el touch
    function handleTouchStart(e) {
      if (isSnapping) return;
      touchStartY = e.touches[0].clientY;
      scrollStartY = window.scrollY;
    }

    // Al soltar el touch
    function handleTouchEnd(e) {
      if (isSnapping) return;

      const scrollEndY = window.scrollY;
      const scrollDiff = scrollEndY - scrollStartY;
      const { section: currentSection, index: currentIndex } = getCurrentSection();

      if (!currentSection) return;

      const sectionHeight = currentSection.getBoundingClientRect().height;
      const scrollThreshold = sectionHeight * SCROLL_THRESHOLD;

      // Scroll hacia abajo (20% o más)
      if (scrollDiff > scrollThreshold && currentIndex < sections.length - 1) {
        isSnapping = true;
        const nextSection = sections[currentIndex + 1];
        
        scrollToSection(nextSection);

        setTimeout(() => {
          isSnapping = false;
        }, 800);
      }
      // Scroll hacia arriba (20% o más)
      else if (scrollDiff < -scrollThreshold && currentIndex > 0) {
        isSnapping = true;
        const prevSection = sections[currentIndex - 1];
        
        scrollToSection(prevSection);

        setTimeout(() => {
          isSnapping = false;
        }, 800);
      }
      // No supera el umbral: volver a la sección actual
      else {
        scrollToSection(currentSection);
      }
    }

    // Agregar listeners
    document.addEventListener('touchstart', handleTouchStart, { passive: true });
    document.addEventListener('touchend', handleTouchEnd, { passive: true });

    // Cleanup al cambiar a desktop
    const handleResize = () => {
      if (window.innerWidth > 768) {
        document.removeEventListener('touchstart', handleTouchStart);
        document.removeEventListener('touchend', handleTouchEnd);
        window.removeEventListener('resize', handleResize);
      }
    };

    window.addEventListener('resize', handleResize);
  }

  // Inicializar cuando el DOM esté listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTouchSnap);
  } else {
    initTouchSnap();
  }
</script>

<style>
  main {
    display: flex;
    flex-flow: column;
    gap: 110px;
    width: 100%;
    margin-top: -90px;
  }

  .main-section-hero {
    position: relative;
    z-index: 0;
    height: 135vh;
  }

  .main-section-hero::after {
    display: block;
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 568px;
    margin-top: 40px;
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center 1%;
    z-index: -1;
  }

  .main-section-features {
    background: linear-gradient(
      186.5deg,
      rgba(11, 11, 11, 0.2) 28.3%,
      rgba(76, 167, 223, 0.2) 48.66%,
      rgba(11, 11, 11, 0.2) 71.03%
    );
  }

  .main-section-presentation {
    background: linear-gradient(
      180deg,
      rgba(11, 11, 11, 0.2) 10.08%,
      rgba(76, 167, 223, 0.2) 43.35%,
      rgba(11, 11, 11, 0.2) 79.9%
    );
  }

  .main-section-form {
    background: url("/images/bgImg_Hero_DarkDeath2x.webp");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center top;
    transition: all 350ms ease-in-out;
  }

  .main-section-faq {
    background: linear-gradient(
      187.39deg,
      rgba(11, 11, 11, 0.2) 28.3%,
      rgba(76, 167, 223, 0.2) 48.66%,
      rgba(11, 11, 11, 0.2) 71.03%
    );
  }

  .main-section-carousel {
    background: linear-gradient(
      184.39deg,
      rgba(11, 11, 11, 0.2) 28.3%,
      rgba(76, 167, 223, 0.2) 48.66%,
      rgba(11, 11, 11, 0.2) 71.03%
    );
  }

  .main-section-capabilities {
    background: linear-gradient(
      184.39deg,
      rgba(11, 11, 11, 0.2) 28.3%,
      rgba(76, 167, 223, 0.2) 48.66%,
      rgba(11, 11, 11, 0.2) 71.03%
    );
  }

  .scroll-down {
    width: 37px;
    height: 86px;
    border: 1px solid white;
    border-radius: 37px;
    display: flex;
    justify-content: center;
    padding: 20px 0;
    align-items: top;
    position: fixed;
    left: 50%;
    transform: translate(-50%, 0);
    bottom: 25px;
    opacity: 1;
    transition: opacity 0.3s ease;
    z-index: 5;
  }

  .scroll-down.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .scroll-down span {
    animation: bounce 2s infinite;
  }

  @media screen and (min-width: 1440px) {
    .main-section-form {
      background-position: calc(50% - 200px) center;
    }
  }

  @media (max-width: 768px) {
    .main-section-hero {
      min-height: 150vh;
    }

    .scroll-down {
      display: none;
    }
  }
</style>